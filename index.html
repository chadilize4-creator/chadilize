<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orb Tycoon — fixed build</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#101720; --muted:#7e8a9a; --ink:#eaf2ff; --accent:#7dd3fc; --accent-2:#22c55e;
      --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink); background:radial-gradient(1200px 600px at 70% -10%,#112235 0%,#0c141d 40%, var(--bg) 100%) fixed;
    }
    .app{max-width:1100px;margin:0 auto;padding:24px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px
    }
    .title{font-weight:800;letter-spacing:.3px;font-size:clamp(18px,2.2vw,22px)}
    .pill{
      display:inline-flex;gap:8px;align-items:center;background:linear-gradient(180deg,#111b27,#0b121a);
      border:1px solid #1e293b;border-radius:999px;padding:8px 12px;box-shadow:var(--shadow)
    }
    .stat{display:flex;gap:8px;align-items:center}
    .stat small{color:var(--muted)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 340px;min-width:320px}
    .card{
      background:linear-gradient(180deg,#0f1722,#0b121a); border:1px solid #1e293b;border-radius:var(--radius);
      box-shadow:var(--shadow); padding:18px
    }
    .card h3{margin:.2rem 0 .6rem;font-size:18px;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .btn{
      border:1px solid #243143;background:linear-gradient(180deg,#182334,#121a27); color:var(--ink);
      border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);font-weight:600
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.primary{border-color:#1e3a5f;background:linear-gradient(180deg,#1a3554,#0f2741)}
    .btn.success{border-color:#1f6c46;background:linear-gradient(180deg,#1e4932,#153624)}
    .btn.danger{border-color:#5f1e1e;background:linear-gradient(180deg,#4b1a1a,#2a0e0e)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .orb-wrap{
      display:grid;place-items:center;padding:22px;border-radius:var(--radius);
      background:radial-gradient(500px 140px at 50% 0%,#0e1a28 0%,#0c131d 45%,#0b0f14 100%);
      border:1px solid #102033;box-shadow:var(--shadow)
    }
    .orb{
      width:min(52vw,360px);height:min(52vw,360px);border-radius:999px;position:relative;cursor:pointer;
      background:radial-gradient(120% 120% at 30% 25%, #9be0ff 0%, #2f7ab2 25%, #0a3555 60%, #061422 100%);
      box-shadow: 0 45px 120px rgba(125,211,252,.22), inset 0 0 40px rgba(255,255,255,.18), inset 0 -40px 120px rgba(0,0,0,.55);
      border:2px solid rgba(255,255,255,.08)
    }
    .orb:active{transform:scale(.985)}
    .orb .glow{
      position:absolute;inset:0;border-radius:inherit;mix-blend-mode:screen;pointer-events:none;
      background:radial-gradient(180px 180px at 28% 24%,rgba(255,255,255,.35),transparent 60%),
                 radial-gradient(120px 120px at 70% 68%,rgba(255,255,255,.18),transparent 60%)
    }
    .list{display:grid;gap:12px}
    .shop-item{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;border:1px solid #233046;border-radius:14px;background:linear-gradient(180deg,#101a28,#0b121a)}
    .shop-meta{display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;color:#0a1b1d;background:linear-gradient(180deg,#a7f3d0,#6ee7b7);padding:3px 8px;border-radius:999px;border:1px solid #0d2c1f}
    .req{font-size:12px;color:#eab308;border:1px dashed #3a2f11;border-radius:999px;padding:2px 6px}
    .lvl{font-size:12px;color:#9ca3af}
    .overlay{
      position:fixed;inset:0;background:rgba(5,10,16,.6);backdrop-filter:blur(6px);
      display:none;align-items:center;justify-content:center;padding:20px;z-index:50;
    }
    .overlay.show{display:flex}
    .modal{width:min(720px,96vw);max-height:86vh;overflow:auto;background:linear-gradient(180deg,#0f1722,#0b121a);border:1px solid #1e293b;border-radius:20px;box-shadow:var(--shadow);padding:18px}
    .modal header{margin:0 0 10px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#1e293b,transparent);margin:12px 0}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    canvas{display:block;background:#071118;border-radius:14px;border:1px solid #1e293b;box-shadow:var(--shadow)}
    input,select{
      width:100%;border-radius:12px;border:1px solid #243143;background:#0e1621;color:var(--ink);
      padding:10px 12px;box-shadow:var(--shadow)
    }
    .footnote{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">🌐 Orb Tycoon — fixed build</div>
      <div class="toolbar">
        <div class="pill stat" id="walletPill">
          <span>💰</span> <span id="chadsTxt">0</span>
          <small id="rateTxt" class="muted" style="margin-left:8px;">(+0/hr)</small>
        </div>
        <button class="btn" id="btnProfile">Profile</button>
        <button class="btn" id="btnShop">Shop</button>
        <button class="btn" id="btnPlay">Play</button>
      </div>
    </header>

    <div class="row">
      <div class="col">
        <div class="card orb-wrap">
          <div id="orb" class="orb" title="Tap to collect">
            <div class="glow"></div>
          </div>
          <p class="muted" style="text-align:center;margin:.9rem 0 0">
            Tap the orb to collect. Your purchases boost passive generation.
          </p>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h3>Upgrades at a glance</h3>
          <div id="quickList" class="list"></div>
          <div class="hr"></div>
          <button id="openShopFromCard" class="btn primary">Open Shop</button>
        </div>
        <div class="card" style="margin-top:16px">
          <h3>Profile</h3>
          <div class="grid-2">
            <div>
              <label class="muted">Name</label>
              <input id="nameInput" placeholder="Your name" />
            </div>
            <div>
              <label class="muted">Avatar</label>
              <select id="avatarSelect">
                <option>🧙‍♂️</option><option>🦊</option><option>🐉</option><option>👩‍🚀</option><option>🤖</option>
              </select>
            </div>
          </div>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button id="saveProfile" class="btn success">Save Profile</button>
            <button id="resetAll" class="btn danger">Reset Progress</button>
          </div>
          <p class="footnote" style="margin-top:10px">Data is stored locally in your browser.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlays -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div role="dialog" aria-modal="true" class="modal" id="modal">
      <header style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="modalTitle" style="margin:0">Modal</h3>
        <button id="closeOverlay" class="btn">Close</button>
      </header>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Confirm dialog (reused) -->
  <div id="confirmOverlay" class="overlay" aria-hidden="true">
    <div role="dialog" aria-modal="true" class="modal" style="max-width:520px">
      <header style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Confirm purchase</h3>
      </header>
      <div id="confirmBody" class="muted" style="margin-top:8px"></div>
      <div class="hr"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="confirmCancel" class="btn">Cancel</button>
        <button id="confirmOk" class="btn success">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // ─────────────────────────────────────────────────────────────────────────────
    // Utilities
    // ─────────────────────────────────────────────────────────────────────────────
    const $ = (q, el=document)=>el.querySelector(q);
    const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));

    // Locale-aware compact numbers (e.g., 12.3K). MDN: Intl.NumberFormat.
    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat
    const fmtCompact = new Intl.NumberFormat(navigator.language || 'en-US', { notation: 'compact', maximumFractionDigits: 2 });
    const fmtFixed = new Intl.NumberFormat(navigator.language || 'en-US', { maximumFractionDigits: 2 });

    const formatChads = n => fmtCompact.format(n);
    const formatRatePerHr = r => `(+${fmtCompact.format(r)}/hr)`;

    function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

    // ─────────────────────────────────────────────────────────────────────────────
    // Data model
    // ─────────────────────────────────────────────────────────────────────────────
    const STORAGE_KEY = 'orb-fixed-build-state-v1';

    // Card catalog with clean names and simple gates
    const CATALOG = [
      {
        id: 'lemonade',
        name: 'Lemonade Stand',
        icon: '🍋',
        levels: [
          { price: 10, genPerHr: 1 },
          { price: 50, genPerHr: 5 },
          { price: 200, genPerHr: 15 },
        ]
      },
      {
        id: 'eiffel',
        name: 'Eiffel Tower Souvenirs',
        icon: '🗼',
        gate: { requires: 'lemonade', minLevel: 2 }, // need Lemonade lvl 2+
        levels: [
          { price: 500, genPerHr: 60 },
          { price: 1800, genPerHr: 220 },
          { price: 6000, genPerHr: 700 },
        ]
      },
      {
        id: 'pyramids',
        name: 'Giza Pyramids Tours',
        icon: '🛕',
        gate: { requires: 'eiffel', minLevel: 1 }, // need Eiffel lvl 1+
        levels: [
          { price: 12000, genPerHr: 1800 },
          { price: 45000, genPerHr: 6500 },
          { price: 150000, genPerHr: 20000 },
        ]
      },
      {
        id: 'greatwall',
        name: 'Great Wall of China Passes',
        icon: '🧱',
        gate: { requires: 'pyramids', minLevel: 1 },
        levels: [
          { price: 300000, genPerHr: 52000 },
          { price: 900000, genPerHr: 150000 },
          { price: 2500000, genPerHr: 400000 },
        ]
      },
      {
        id: 'space',
        name: 'Orbital Snack Bar',
        icon: '🛰️',
        gate: { requires: 'greatwall', minLevel: 2 },
        levels: [
          { price: 10000000, genPerHr: 2000000 },
          { price: 28000000, genPerHr: 6000000 },
          { price: 80000000, genPerHr: 18000000 },
        ]
      },
    ];

    const DEFAULT_STATE = {
      name: '',
      avatarIndex: 0,
      chads: 0,            // currency
      genPerHr: 0,         // total passive generation per hour
      levels: {},          // {cardId: currentLevel}
      lastSeen: Date.now() // for offline earnings
    };

    let STATE = loadState();

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(DEFAULT_STATE);
      try{
        const s = JSON.parse(raw);
        return { ...structuredClone(DEFAULT_STATE), ...s };
      }catch{
        return structuredClone(DEFAULT_STATE);
      }
    }
    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Derived state + rendering
    // ─────────────────────────────────────────────────────────────────────────────
    function computeGenPerHr(){
      let sum = 0;
      for(const card of CATALOG){
        const lvl = STATE.levels[card.id] || 0;
        if(lvl>0){
          // sum all earned gen from purchased levels
          // (here we take the gen of the current level; design choice)
          sum += card.levels[clamp(lvl-1,0,card.levels.length-1)].genPerHr;
        }
      }
      STATE.genPerHr = sum;
    }

    function renderWallet(){
      $('#chadsTxt').textContent = formatChads(STATE.chads);
      $('#rateTxt').textContent = formatRatePerHr(STATE.genPerHr);
    }

    function unmetGate(card){
      if(!card.gate) return null;
      const have = STATE.levels[card.gate.requires] || 0;
      if(have >= (card.gate.minLevel||1)) return null;
      const reqCard = CATALOG.find(c=>c.id===card.gate.requires);
      return `${reqCard ? reqCard.name : card.gate.requires} lvl ${card.gate.minLevel || 1}`;
    }

    function renderQuick(){
      const host = $('#quickList');
      host.innerHTML = '';
      for(const card of CATALOG){
        const lvl = STATE.levels[card.id] || 0;
        const nextIdx = lvl; // zero-based
        const next = card.levels[nextIdx];
        const li = document.createElement('div');
        li.className = 'shop-item';
        const lock = unmetGate(card);

        const left = document.createElement('div');
        left.className = 'shop-meta';
        left.innerHTML = `
          <div style="font-size:22px">${card.icon}</div>
          <div>
            <div><strong>${card.name}</strong> <span class="lvl">lvl ${lvl}</span></div>
            <div class="muted">${next ? `Next: ${formatChads(next.price)} • +${fmtCompact.format(next.genPerHr)}/hr` : 'Maxed'}</div>
          </div>
        `;
        const right = document.createElement('div');
        if(lock){
          right.innerHTML = `<span class="req">Requires ${lock}</span>`;
        }else{
          const b = document.createElement('button');
          b.className = 'btn primary';
          b.textContent = next ? 'Buy' : 'Maxed';
          b.disabled = !next;
          b.addEventListener('click', ()=> openShop(card.id));
          right.appendChild(b);
        }
        li.append(left, right);
        host.appendChild(li);
      }
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Shop overlay with confirm modal
    // ─────────────────────────────────────────────────────────────────────────────
    function openShop(focusId=null){
      openOverlay('Shop', buildShopHTML());
      // focus scroll to item if provided
      if(focusId){
        setTimeout(()=>{
          const el = document.getElementById(`shop-${focusId}`);
          if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
        }, 0);
      }
    }

    function buildShopHTML(){
      const wrap = document.createElement('div');
      wrap.className = 'list';
      for(const card of CATALOG){
        const lvl = STATE.levels[card.id] || 0;
        const nextIdx = lvl;
        const next = card.levels[nextIdx];
        const lock = unmetGate(card);

        const row = document.createElement('div');
        row.className = 'shop-item';
        row.id = `shop-${card.id}`;

        const meta = document.createElement('div');
        meta.className = 'shop-meta';
        meta.innerHTML = `
          <div style="font-size:26px">${card.icon}</div>
          <div>
            <div style="display:flex;gap:8px;align-items:center">
              <strong>${card.name}</strong> <span class="badge">lvl ${lvl}</span>
            </div>
            <div class="muted">
              ${next ? `Next level gives <strong>+${fmtCompact.format(next.genPerHr)}/hr</strong>` : 'Fully upgraded'}
            </div>
          </div>
        `;

        const actions = document.createElement('div');
        if(lock){
          actions.innerHTML = `<span class="req">Requires ${lock}</span>`;
        }else{
          const cost = document.createElement('div');
          cost.className = 'muted';
          cost.textContent = next ? `Cost: ${formatChads(next.price)}` : '';
          const btn = document.createElement('button');
          btn.className = 'btn primary';
          btn.textContent = next ? 'Buy level' : 'Maxed';
          btn.disabled = !next;
          if(next){
            btn.addEventListener('click', ()=>{
              // Confirm flow
              const msg = `
                Buy <strong>${card.name}</strong> level ${lvl+1}?<br>
                Cost: ${formatChads(next.price)} — New rate: +${fmtCompact.format(next.genPerHr)}/hr
              `;
              openConfirm(msg, ()=>{
                attemptPurchase(card.id, next.price, next.genPerHr);
                // refresh overlays
                computeGenPerHr();
                renderWallet();
                replaceOverlayBody(buildShopHTML());
                renderQuick();
              });
            });
          }
          actions.append(cost, btn);
        }

        row.append(meta, actions);
        wrap.appendChild(row);
      }
      return wrap;
    }

    function attemptPurchase(cardId, price, genGain){
      if(STATE.chads < price){
        toast('Not enough funds.');
        return false;
      }
      STATE.chads -= price;
      STATE.levels[cardId] = (STATE.levels[cardId] || 0) + 1;
      saveState();
      return true;
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Overlay + Confirm helpers
    // ─────────────────────────────────────────────────────────────────────────────
    const overlayEl = $('#overlay');
    const modalBodyEl = $('#modalBody');
    const modalTitleEl = $('#modalTitle');

    function openOverlay(title, node){
      modalTitleEl.textContent = title;
      replaceOverlayBody(node);
      overlayEl.classList.add('show');
      overlayEl.setAttribute('aria-hidden','false');
    }
    function replaceOverlayBody(node){
      modalBodyEl.innerHTML = '';
      if(node instanceof Node) modalBodyEl.appendChild(node);
      else if(typeof node === 'string') modalBodyEl.innerHTML = node;
    }
    function closeOverlay(){
      overlayEl.classList.remove('show');
      overlayEl.setAttribute('aria-hidden','true');
      modalBodyEl.innerHTML = '';
    }
    $('#closeOverlay').addEventListener('click', closeOverlay);

    // reusable confirm
    let confirmOkCb = null;
    function openConfirm(html, onOk){
      $('#confirmBody').innerHTML = html;
      $('#confirmOverlay').classList.add('show');
      $('#confirmOverlay').setAttribute('aria-hidden','false');
      confirmOkCb = onOk;
    }
    function closeConfirm(){
      $('#confirmOverlay').classList.remove('show');
      $('#confirmOverlay').setAttribute('aria-hidden','true');
      $('#confirmBody').textContent = '';
      confirmOkCb = null;
    }
    $('#confirmCancel').addEventListener('click', closeConfirm);
    $('#confirmOk').addEventListener('click', ()=>{
      if(typeof confirmOkCb === 'function') confirmOkCb();
      closeConfirm();
    });

    // ─────────────────────────────────────────────────────────────────────────────
    // Profile
    // ─────────────────────────────────────────────────────────────────────────────
    function applyProfileToForm(){
      $('#nameInput').value = STATE.name || '';
      $('#avatarSelect').selectedIndex = clamp(STATE.avatarIndex||0, 0, $('#avatarSelect').options.length-1);
    }
    function saveProfileFromForm(){
      STATE.name = $('#nameInput').value.trim();
      STATE.avatarIndex = $('#avatarSelect').selectedIndex;
      saveState();
      toast('Profile saved');
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Orb / earnings
    // ─────────────────────────────────────────────────────────────────────────────
    const orbEl = $('#orb');
    orbEl.addEventListener('click', ()=>{
      STATE.chads += 1;
      renderWallet();
      saveState();
      // click sparkle
      orbEl.animate([{transform:'scale(1)'},{transform:'scale(.985)'},{transform:'scale(1)'}],{duration:150});
    });

    // Example passive event listeners (touch/wheel) — don’t call preventDefault here.
    // MDN: addEventListener options (passive).
    // https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener
    document.addEventListener('touchstart', ()=>{}, {passive:true});
    document.addEventListener('wheel', ()=>{}, {passive:true});

    // accrue offline earnings
    function applyOfflineEarnings(){
      const now = Date.now();
      const elapsedSec = (now - (STATE.lastSeen||now)) / 1000;
      if(elapsedSec > 1 && STATE.genPerHr>0){
        const earned = (STATE.genPerHr/3600) * elapsedSec;
        STATE.chads += earned;
      }
      STATE.lastSeen = now;
      saveState();
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Play: Snake (rAF game loop)
    // MDN recommends rAF-driven loops for games/animation:
    // https://developer.mozilla.org/en-US/docs/Games/Anatomy
    // ─────────────────────────────────────────────────────────────────────────────
    function openPlay(){
      const host = document.createElement('div');
      host.innerHTML = `
        <div class="grid-2">
          <div><canvas id="snakeCanvas" width="420" height="420"></canvas></div>
          <div>
            <h3>Snake</h3>
            <p class="muted">Eat apples, avoid your tail. Arrow keys to move. Pause with [P].</p>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <button id="snakeStart" class="btn success">Start</button>
              <button id="snakePause" class="btn">Pause</button>
              <div id="snakeScore" class="pill">Score: 0</div>
            </div>
          </div>
        </div>
      `;
      openOverlay('Play', host);
      setupSnake($('#snakeCanvas'));
    }

    function setupSnake(canvas){
      const ctx = canvas.getContext('2d');
      const grid = 20;                       // 20x20 grid
      const cell = canvas.width / grid;
      let snake = [{x:10,y:10},{x:9,y:10},{x:8,y:10}];
      let dir = {x:1, y:0};
      let pendingDir = dir;
      let apple = spawnApple();
      let score = 0;
      let running = false;
      let lastStep = performance.now();
      let stepEveryMs = 120;                 // base speed; lower = faster

      function spawnApple(){
        let a;
        do{
          a = { x: Math.floor(Math.random()*grid), y: Math.floor(Math.random()*grid) };
        }while(snake.some(s=>s.x===a.x && s.y===a.y));
        return a;
      }

      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // board
        ctx.fillStyle = '#0b1724';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        // grid dots
        ctx.globalAlpha = .15;
        for(let i=0;i<grid;i++){
          for(let j=0;j<grid;j++){
            ctx.fillStyle = '#8fb7ff';
            ctx.fillRect(i*cell+cell*.45,j*cell+cell*.45,cell*.1,cell*.1);
          }
        }
        ctx.globalAlpha = 1;

        // apple
        ctx.fillStyle = '#f43f5e';
        ctx.beginPath();
        ctx.arc((apple.x+0.5)*cell,(apple.y+0.5)*cell, cell*.35, 0, Math.PI*2);
        ctx.fill();

        // snake
        ctx.fillStyle = '#7dd3fc';
        for(const s of snake){
          ctx.fillRect(s.x*cell+2,s.y*cell+2,cell-4,cell-4);
        }
      }

      function step(){
        // apply pending direction (no 180° turns)
        if((pendingDir.x !== -dir.x) || (pendingDir.y !== -dir.y)){
          dir = pendingDir;
        }
        const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
        // wrap
        head.x = (head.x + grid) % grid;
        head.y = (head.y + grid) % grid;

        // collide with tail
        if(snake.some((s,i)=> i>0 && s.x===head.x && s.y===head.y)){
          running = false;
          toast('Game over');
        }else{
          snake.unshift(head);
          if(head.x===apple.x && head.y===apple.y){
            score++;
            $('#snakeScore').textContent = `Score: ${score}`;
            STATE.chads += 5; // tiny reward
            renderWallet(); saveState();
            apple = spawnApple();
            stepEveryMs = Math.max(60, stepEveryMs * 0.98); // speed up
          }else{
            snake.pop();
          }
        }
      }

      function tick(now){
        if(running){
          const elapsed = now - lastStep;
          if(elapsed >= stepEveryMs){
            step();
            lastStep = now;
          }
          draw();
        }
        // schedule next frame
        requestAnimationFrame(tick);
      }

      // controls
      function onKey(e){
        switch(e.key){
          case 'ArrowUp':   pendingDir = {x:0,y:-1}; break;
          case 'ArrowDown': pendingDir = {x:0,y: 1}; break;
          case 'ArrowLeft': pendingDir = {x:-1,y:0}; break;
          case 'ArrowRight':pendingDir = {x: 1,y:0}; break;
          case 'p': case 'P': running = !running; break;
        }
      }
      document.addEventListener('keydown', onKey);
      $('#snakeStart').addEventListener('click', ()=>{ running = true; });
      $('#snakePause').addEventListener('click', ()=>{ running = false; });

      draw();
      requestAnimationFrame(tick);
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // App loop: passive income via rAF time delta
    // ─────────────────────────────────────────────────────────────────────────────
    let lastTime = performance.now();
    function appTick(now){
      const dt = (now - lastTime) / 1000; // seconds
      lastTime = now;

      if(STATE.genPerHr > 0){
        const perSec = STATE.genPerHr / 3600;
        STATE.chads += perSec * dt;
        // Only repaint wallet ~10Hz to avoid layout thrash
        if(now % 100 < 16) renderWallet();
      }
      requestAnimationFrame(appTick);
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Toast
    // ─────────────────────────────────────────────────────────────────────────────
    let toastTimer = null;
    function toast(msg){
      let t = document.getElementById('toast');
      if(!t){
        t = document.createElement('div');
        t.id = 'toast';
        t.style.position = 'fixed';
        t.style.bottom = '20px';
        t.style.left = '50%';
        t.style.transform = 'translateX(-50%)';
        t.style.background = 'linear-gradient(180deg,#17263a,#0f1a2a)';
        t.style.border = '1px solid #243143';
        t.style.padding = '10px 14px';
        t.style.borderRadius = '14px';
        t.style.boxShadow = 'var(--shadow)';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = '0';
      t.style.transition = 'opacity .15s ease';
      t.style.opacity = '1';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ t.style.opacity = '0'; }, 1500);
    }

    // ─────────────────────────────────────────────────────────────────────────────
    // Wire up controls
    // ─────────────────────────────────────────────────────────────────────────────
    $('#btnShop').addEventListener('click', ()=> openShop());
    $('#openShopFromCard').addEventListener('click', ()=> openShop());
    $('#btnPlay').addEventListener('click', openPlay);
    $('#btnProfile').addEventListener('click', ()=>{
      const view = document.createElement('div');
      view.innerHTML = `
        <div class="grid-2">
          <div>
            <label class="muted">Name</label>
            <input id="profileName" value="${(STATE.name||'').replace(/"/g,'&quot;')}" />
          </div>
          <div>
            <label class="muted">Avatar</label>
            <select id="profileAvatar">
              <option ${STATE.avatarIndex===0?'selected':''}>🧙‍♂️</option>
              <option ${STATE.avatarIndex===1?'selected':''}>🦊</option>
              <option ${STATE.avatarIndex===2?'selected':''}>🐉</option>
              <option ${STATE.avatarIndex===3?'selected':''}>👩‍🚀</option>
              <option ${STATE.avatarIndex===4?'selected':''}>🤖</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button id="profileSave" class="btn success">Save</button>
          <button id="profileCancel" class="btn">Close</button>
        </div>
      `;
      openOverlay('Profile', view);
      $('#profileSave').addEventListener('click', ()=>{
        STATE.name = $('#profileName').value.trim();
        STATE.avatarIndex = $('#profileAvatar').selectedIndex;
        saveState();
        applyProfileToForm();
        renderWallet();
        toast('Profile saved');
      });
      $('#profileCancel').addEventListener('click', closeOverlay);
    });

    $('#saveProfile').addEventListener('click', saveProfileFromForm);
    $('#resetAll').addEventListener('click', ()=>{
      openConfirm(
        `Reset all progress for <strong>${STATE.name || 'this profile'}</strong>? This can’t be undone.`,
        ()=>{
          STATE = structuredClone(DEFAULT_STATE);
          saveState();
          computeGenPerHr();
          applyProfileToForm();
          renderWallet();
          renderQuick();
          toast('Progress reset');
        }
      );
    });

    // Close overlay on backdrop click or ESC
    overlayEl.addEventListener('click', (e)=>{ if(e.target===overlayEl) closeOverlay(); });
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if(overlayEl.classList.contains('show')) closeOverlay();
        if($('#confirmOverlay').classList.contains('show')) closeConfirm();
      }
    });

    // ─────────────────────────────────────────────────────────────────────────────
    // Init
    // ─────────────────────────────────────────────────────────────────────────────
    (function init(){
      // compute gen from purchases
      computeGenPerHr();
      // offline earnings
      applyOfflineEarnings();
      // paint UI
      applyProfileToForm();
      renderWallet();
      renderQuick();
      // start rAF loop
      requestAnimationFrame((t)=>{ lastTime = t; requestAnimationFrame(appTick); });
    })();
  </script>
</body>
</html>
